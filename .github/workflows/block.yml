name: ğš»Õ°Ò½ ğš¨Åêª®â²›ğ›† ğŸš©ğ—§Îµá§˜â€Œá´

on:
  push:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  full-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      # âœ… Install uv (CI-safe)
      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv

      # âœ… Verify uv (debug safety)
      - name: Verify uv
        run: uv --version

      # ğŸ”¥ NEW: pyproject.toml ke hisab se lock update
      - name: Generate uv.lock from pyproject.toml
        run: uv lock

      # Sync deps from lock
      - name: Sync from uv.lock
        run: uv sync

      # Tools
      - name: Install tools
        run: uv pip install black isort ruff pip-audit

      - name: Format python files
        run: |
          uv run black .
          uv run isort .

      - name: Ruff auto-fix
        run: |
          uv run ruff check . \
            --fix \
            --unsafe-fixes \
            --exit-zero

      # ğŸ” Lock consistency check
      - name: Detect changes
        run: |
          uv lock --check || true
          if [ -n "$(git status --porcelain)" ]; then
            echo "CHANGED=true" >> $GITHUB_ENV
          else
            echo "CHANGED=false" >> $GITHUB_ENV
          fi

      # Security scan
      - name: Dependency audit
        continue-on-error: true
        run: uv run pip-audit

      # Auto PR
      - name: Create Pull Request
        if: env.CHANGED == 'true' && github.actor != 'github-actions[bot]'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "ğš»Õ°Ò½ ğš¨Åêª®â²›ğ›† ğŸš©ğ—§Îµá§˜â€Œá´ + #âŸ¶Ì½ à¤œà¤¯ à¤¶à¥à¤°à¥€ à¼¢à¼à¤® >ğŸ‘ğŸ™ğŸš©"
          title: "âœ… Automated repo auto-fix"
          body: |
            âœ” pyproject.toml sync  
            âœ” uv.lock regenerated  
            âœ” Black formatting  
            âœ” Import sorting (isort)  
            âœ” Ruff auto-fix  
            âœ” Security audit  
          labels: auto-fix, uv, ci
          branch: repo-auto-check-${{ github.run_id }}
          delete-branch: true
